<?xml version="1.0" encoding="iso-8859-1"?>

<!-- Please see the license.html file included with this distribution for 
	attribution and copyright information. -->

<root>
	<windowclass name="table">
		<frame>recordsheet</frame>
		<placement>
			<size width="400" height="400" />
		</placement>
		<sizelimits>
			<minimum width="400" height="400" />
			<dynamic />
		</sizelimits>
		<minimize>minimized_utility</minimize>
		<nodelete />
		<playercontrol />
		<sharable />
		<tooltip field="name" />
		<script>
			function onInit()
			local sNode = getDatabaseNode().getNodeName();
			DB.addHandler(sNode .. ".locked", "onUpdate", onLockChanged);
			onLockChanged();
			end

			function onClose()
			local sNode = getDatabaseNode().getNodeName();
			DB.removeHandler(sNode .. ".locked", "onUpdate", onLockChanged);
			end

			function onLockChanged()
			if header.subwindow then
			header.subwindow.update();
			end
			if main.subwindow then
			main.subwindow.update();
			end

			local bReadOnly = WindowManager.getReadOnlyState(getDatabaseNode());
			notes.setReadOnly(bReadOnly);
			end
		</script>
		<sheetdata>
			<sub_record_header name="header">
				<class>table_header</class>
			</sub_record_header>

			<genericcontrol name="contentframe">
				<anchored>
					<top parent="header" anchor="bottom" offset="15" />
					<left offset="20" />
					<right offset="-45" />
					<bottom offset="-32" />
				</anchored>
				<frame name="groupbox" offset="10,17,24,17" />
				<disabled />
			</genericcontrol>

			<subwindow_record name="main">
				<class>table_main</class>
				<script>
					function onDrop(x, y, draginfo)
					return subwindow.onDrop(x, y, draginfo);
					end
				</script>
			</subwindow_record>
			<ft_record name="notes">
				<anchored to="contentframe">
					<top />
					<left offset="10" />
					<right />
					<bottom />
				</anchored>
				<empty>Click to enter text</empty>
				<invisible />
			</ft_record>

			<scrollbar_record>
				<target>main</target>
			</scrollbar_record>
			<scrollbar_record>
				<target>notes</target>
			</scrollbar_record>

			<tabs_recordsheet>
				<tab>
					<icon>tab_main</icon>
					<subwindow>main</subwindow>
				</tab>
				<tab>
					<icon>tab_notes</icon>
					<subwindow>notes</subwindow>
				</tab>
			</tabs_recordsheet>

			<resize_recordsheet />
			<close_recordsheet />
		</sheetdata>
	</windowclass>

	<windowclass name="table_header">
		<margins control="0,0,0,7" />
		<script>
			function onInit()
			update();
			end
			function update()
			local bReadOnly = WindowManager.getReadOnlyState(getDatabaseNode());
			name.setReadOnly(bReadOnly);
			end
		</script>
		<sheetdata>
			<link_record_header>
				<class>table</class>
			</link_record_header>
			<string_record_name name="name">
				<anchored>
					<top offset="5" />
					<left offset="40" />
					<right offset="-40" />
				</anchored>
				<empty>&#171; New Table &#187;</empty>
			</string_record_name>

			<genericcontrol name="rightanchor">
				<anchored height="0" width="0">
					<top />
					<right />
				</anchored>
			</genericcontrol>
			<icon_record_locked name="hardlocked">
				<anchored height="20" width="20">
					<top offset="5" />
					<right parent="rightanchor" anchor="left" relation="relative"
						offset="-5" />
				</anchored>
			</icon_record_locked>
			<button_record_locked name="locked">
				<anchored height="20" width="20">
					<top offset="5" />
					<right parent="rightanchor" anchor="left" relation="relative"
						offset="-5" />
				</anchored>
			</button_record_locked>
		</sheetdata>
	</windowclass>

	<template name="label_tablecolumn">
		<stringfield>
			<anchored width="100">
				<bottom parent="header_die" />
				<left offset="50" />
			</anchored>
			<stateframe>
				<keyedit name="fieldfocus" offset="7,5,7,5" />
			</stateframe>
			<font>sheetlabel</font>
			<empty>&#171; Label &#187;</empty>
			<multilinespacing>20</multilinespacing>
			<nodrag />
			<nodragselect />
			<center />
			<script>
				function onInit()
				registerMenuItem("Delete Column", "delete", 4);
				end

				function onMenuSelection(selection)
				if selection == 4 then
				window.setColumns(window.getColumns() - 1);
				end
				end

				function onValueChanged()
				window.updateColumns();
				end
			</script>
		</stringfield>
	</template>

	<windowclass name="table_result">
		<margins control="0,0,0,2" />
		<sheetdata>
			<stringfield name="result">
				<anchored>
					<top offset="2" />
					<left offset="5" />
					<right offset="-10" />
				</anchored>
				<stateframe>
					<keyedit name="fieldfocus" offset="7,5,7,5" />
				</stateframe>
				<font>sheettext</font>
				<multilinespacing>20</multilinespacing>
				<empty> -- </empty>
				<nodrag />
				<nodragselect />
				<nohighlight />
				<script file="common/scripts/list_textitem.lua" />
			</stringfield>
		</sheetdata>
	</windowclass>

	<windowclass name="table_row">
		<margins control="0,0,0,2" />
		<script>
			function onInit()
			if User.isHost() then
			registerMenuItem("Delete Row", "delete", 6);
			end
			end

			function onMenuSelection(selection)
			if selection == 6 then
			getDatabaseNode().delete();
			end
			end
		</script>
		<sheetdata>
			<basicnumber name="fromrange">
				<bounds>5,2,20,20</bounds>
				<hideonvalue>0</hideonvalue>
				<delaykeyupdate />
				<nodrag />
				<script>
					function onValueChanged()
					window.windowlist.onRangeChanged();
					end
				</script>
			</basicnumber>
			<label name="dash">
				<bounds>30,2,5,20</bounds>
				<static>-</static>
				<center />
			</label>
			<basicnumber name="torange">
				<bounds>40,2,20,20</bounds>
				<hideonvalue>0</hideonvalue>
				<delaykeyupdate />
				<nodrag />
				<script>
					function onValueChanged()
					window.windowlist.onRangeChanged();
					end
				</script>
			</basicnumber>

			<genericcontrol name="rightanchor">
				<anchored height="0" width="0">
					<top />
					<right />
				</anchored>
			</genericcontrol>
			<button_idelete name="idelete">
				<anchored>
					<top offset="2" />
					<right parent="rightanchor" anchor="left" relation="relative"
						offset="-5" />
				</anchored>
			</button_idelete>

			<windowlist name="results">
				<anchored>
					<top />
					<left offset="70" />
					<right parent="rightanchor" anchor="left" relation="relative"
						offset="-5" />
				</anchored>
				<class>table_result</class>
				<datasource>.results</datasource>
				<createonempty />
				<noscroll />
				<columns width="150" fillwidth="true" />
			</windowlist>
		</sheetdata>
	</windowclass>

	<windowclass name="table_main">
		<margins control="0,0,0,5" />
		<script file="campaign/scripts/table_main.lua" />
		<sheetdata>
			<hn name="table_positionoffset" />
			<hn name="resultscols">
				<default>1</default>
				<min>1</min>
				<max>20</max>
				<script>
					function onValueChanged()
					window.onColumnsChanged();
					end
				</script>
			</hn>

			<anchor_column name="columnanchor" />

			<basicstring name="description">
				<anchored>
					<top parent="columnanchor" anchor="bottom" relation="relative"
						offset="7" />
					<left offset="15" />
					<right offset="-10" />
				</anchored>
				<multilinespacing>20</multilinespacing>
				<empty>&#171; Description &#187;</empty>
			</basicstring>

			<genericcontrol name="rightanchor">
				<anchored height="20" width="0">
					<top parent="columnanchor" anchor="bottom" relation="relative"
						offset="10" />
					<right offset="-5" />
				</anchored>
			</genericcontrol>
			<button_roll name="button_roll">
				<anchored width="25" height="25">
					<top parent="rightanchor" offset="-2" />
					<left offset="10" />
				</anchored>
				<script>
					function action(draginfo)
					TableManager.performRoll(draginfo, nil, window.getDatabaseNode(), 0, true);
					return true;
					end

					function onDragStart(button, x, y, draginfo)
					return action(draginfo);
					end

					function onButtonPress()
					return action();
					end
				</script>
			</button_roll>
			<buttonfield name="hiderollresults">
				<anchored height="20" width="20">
					<top parent="rightanchor" offset="1" />
					<left parent="button_roll" anchor="right" offset="15" />
				</anchored>
				<frame name="fielddark" offset="10,6,10,4" />
				<state icon="visibilityon" tooltip="Show Roll Results" />
				<state icon="visibilityoff" tooltip="Hide Roll Results" />
			</buttonfield>

			<genericcontrol name="frame_header">
				<anchored height="15">
					<top parent="columnanchor" anchor="bottom" relation="relative"
						offset="7" />
					<left />
					<right />
				</anchored>
				<disabled />
			</genericcontrol>

			<label name="header_die">
				<anchored width="60">
					<bottom parent="frame_header" />
					<left offset="10" />
				</anchored>
				<center />
			</label>

			<windowlist name="tablerows">
				<anchored>
					<top parent="columnanchor" anchor="bottom" relation="relative"
						offset="2" />
					<left offset="10" />
					<right offset="-10" />
				</anchored>
				<datasource>.tablerows</datasource>
				<class>table_row</class>
				<noscroll />
				<sortby>
					<control>fromrange</control>
				</sortby>
				<child>
					<backcolor>1A40301E</backcolor>
				</child>
				<child />
				<script>
					function onListChanged()
					update();
					end
					function update()
					local bEditMode = (window.table_iedit.getValue() == 1);
					for _,w in ipairs(getWindows()) do
					w.idelete.setVisible(bEditMode);
					end
					end
					function onRangeChanged()
					window.updateDieHeader();
					end
				</script>
			</windowlist>

			<button_iedit name="table_iedit">
				<anchored to="tablerows" position="aboveright" offset="5,30" />
				<target>list</target>
				<script>
					function onValueChanged()
					local bEditMode = (getValue() == 1);
					window.table_iadd_column.setVisible(bEditMode);
					window.table_idelete_column.setVisible(bEditMode);
					window.table_iadd_row.setVisible(bEditMode);
					window.tablerows.update();
					end
				</script>
			</button_iedit>
			<button_iadd name="table_iadd_row">
				<anchored to="table_iedit" position="lefthigh" offset="5,0" />
				<tooltip text="Add Row" />
				<script>
					function onButtonPress()
					window.addRow();
					end
				</script>
			</button_iadd>
			<button_icon name="table_idelete_column">
				<anchored to="tablerows" width="20" height="20">
					<top offset="-50" />
					<right anchor="center" offset="-5" />
				</anchored>
				<icon normal="button_col_delete" />
				<tooltip text="Delete Column" />
				<invisible />
				<script>
					function onButtonPress()
					window.setColumns(window.getColumns() - 1);
					end
				</script>
			</button_icon>
			<button_icon name="table_iadd_column">
				<anchored to="tablerows" width="20" height="20">
					<top offset="-50" />
					<left anchor="center" offset="5" />
				</anchored>
				<icon normal="button_col_insert" />
				<tooltip text="Add Column" />
				<invisible />
				<script>
					function onButtonPress()
					window.setColumns(window.getColumns() + 1);
					end
				</script>
			</button_icon>
		</sheetdata>
	</windowclass>
</root>
