<?xml version="1.0" encoding="iso-8859-1"?>

<!-- Please see the license.html file included with this distribution for 
	attribution and copyright information. -->

<root>
	<windowclass name="charsheet_combat">
		<sheetdata>
			<frame_char name="combatframe">
				<bounds>15,10,-29,120</bounds>
			</frame_char>
		
		<!-- Defense roll -->
            <number_charattribute_base name="defense_base"
			source="attributes.defense.base">
                <anchored to="combatframe"
				position="insidetopleft"
				offset = "85,20"
				/>
				<target>defense</target>
                <description text="Defense base score" />
                <tooltip>
                    <text>The base defense score</text>
                </tooltip>
            </number_charattribute_base>
            
            <string_charattribute_label>
                <anchored to="defense_base"/>
                <static>Defense</static>
            </string_charattribute_label>
           
            <number_charattribute_permmod name="defense_augs"
                source="attributes.defense.augs">
                <anchored to="defense_base" />
                <target>defense</target> 
                <description text="defense augmentations" />
                <tooltip>
                    <text>Augmentations to the defense score</text>
                </tooltip>
            </number_charattribute_permmod>
            
            <number_charattribute_tempmod name="defense_tempmod"
                source="attributes.defense.temp">
                <anchored to="defense_base"/>
                <target>defense</target>
                <description text="defense temporary modifier" />
                <tooltip>
                    <text>Temporary modifiers to the defense score</text>
                </tooltip>
            </number_charattribute_tempmod>
            
            <number_charattribute_score name="defense"
                source="attributes.defense.score">
                <anchored to="defense_base" />
                <description text="defense final score" />
                <target>defense</target>
                <alabel>defense</alabel>
                <tooltip>
                    <text>Current defense score</text>
                </tooltip>
            </number_charattribute_score>
		<!-- Soak roll -->
            <number_charattribute_base name="soak_base"
			source="attributes.soak.base">
                <anchored to="combatframe"
				position="insidetopleft"
				offset = "85,45"
				/>
				<target>soak</target>
                <description text="Soak base score" />
                <tooltip>
                    <text>The base soak score</text>
                </tooltip>
            </number_charattribute_base>
            
            <string_charattribute_label>
                <anchored to="soak_base"/>
                <static>Soak</static>
            </string_charattribute_label>
           
            <number_charattribute_permmod name="soak_augs"
                source="attributes.soak.augs">
                <anchored to="soak_base" />
                <target>soak</target> 
                <description text="soak augmentations" />
                <tooltip>
                    <text>Augmentations to the soak score</text>
                </tooltip>
            </number_charattribute_permmod>
            
            <number_charattribute_tempmod name="soak_tempmod"
                source="attributes.soak.temp">
                <anchored to="soak_base"/>
                <target>soak</target>
                <description text="soak temporary modifier" />
                <tooltip>
                    <text>Temporary modifiers to the soak score</text>
                </tooltip>
            </number_charattribute_tempmod>
            
            <number_charattribute_score name="soak"
                source="attributes.soak.score">
                <anchored to="soak_base" />
                <description text="soak final score" />
                <target>soak</target>
                <alabel>soak</alabel>
                <tooltip>
                    <text>Current soak score</text>
                </tooltip>
            </number_charattribute_score>
		<!-- surprise roll -->
            <number_charattribute_base name="surprise_base"
			source="attributes.surprise.base">
                <anchored to="combatframe"
				position="insidetopleft"
				offset = "85,70"
				/>
				<target>surprise</target>
                <description text="surprise base score" />
                <tooltip>
                    <text>The base surprise score</text>
                </tooltip>
            </number_charattribute_base>
            
            <string_charattribute_label>
                <anchored to="surprise_base"/>
                <static>Surprise</static>
            </string_charattribute_label>
           
            <number_charattribute_permmod name="surprise_augs"
                source="attributes.surprise.augs">
                <anchored to="surprise_base" />
                <target>surprise</target> 
                <description text="surprise augmentations" />
                <tooltip>
                    <text>Augmentations to the surprise score</text>
                </tooltip>
            </number_charattribute_permmod>
            
            <number_charattribute_tempmod name="surprise_tempmod"
                source="attributes.surprise.temp">
                <anchored to="surprise_base"/>
                <target>surprise</target>
                <description text="surprise temporary modifier" />
                <tooltip>
                    <text>Temporary modifiers to the surprise score</text>
                </tooltip>
            </number_charattribute_tempmod>
            
            <number_charattribute_score name="surprise"
                source="attributes.surprise.score">
                <anchored to="surprise_base" />
                <description text="surprise final score" />
                <target>surprise</target>
                <alabel>surprise</alabel>
                <tooltip>
                    <text>Current surprise score</text>
                </tooltip>
            </number_charattribute_score>
			<!-- Drain roll -->
            <number_charattribute_base name="drain_base"
			source="attributes.drain.base">
                <anchored to="combatframe"
				position="insidetopleft"
				offset = "300,20"
				/>
				<target>drain</target>
                <description text="Drain base score" />
                <tooltip>
                    <text>The base drain score</text>
                </tooltip>
            </number_charattribute_base>
            
            <string_charattribute_label>
                <anchored to="drain_base"/>
                <static>Drain</static>
            </string_charattribute_label>
           
            <number_charattribute_permmod name="drain_augs"
                source="attributes.drain.augs">
                <anchored to="drain_base" />
                <target>drain</target> 
                <description text="drain augmentations" />
                <tooltip>
                    <text>Augmentations to the drain score</text>
                </tooltip>
            </number_charattribute_permmod>
            
            <number_charattribute_tempmod name="drain_tempmod"
                source="attributes.drain.temp">
                <anchored to="drain_base"/>
                <target>drain</target>
                <description text="drain temporary modifier" />
                <tooltip>
                    <text>Temporary modifiers to the drain score</text>
                </tooltip>
            </number_charattribute_tempmod>
            
            <number_charattribute_score name="drain"
                source="attributes.drain.score">
                <anchored to="drain_base" />
                <description text="drain final score" />
                <target>drain</target>
                <alabel>drain</alabel>
                <tooltip>
                    <text>Current drain score</text>
                </tooltip>
            </number_charattribute_score>
			
	<!-- Weaponshit -->
		<frame_char name="weaponframe">
			<bounds>15,125,-29,-5</bounds>
		</frame_char>
		
		<genericcontrol name="rightanchor">
				<anchored to="weaponframe" width="0" height="0">
					<top offset="10" />
					<right offset="-20" />
				</anchored>
				<invisible />
			</genericcontrol>

			<label name="dicepool_label">
				<anchored to="rightanchor" width="30">
					<top offset="27"/>
					<right anchor="left" relation="relative" offset="-3" />
				</anchored>
				<center />
				<static>Pool</static>
				<tooltip text="Final Dice Pool" />
			</label>
			<label name="tempmodifier_label">
				<anchored to="rightanchor" width="30">
					<top offset="27"/>
					<right anchor="left" relation="relative" offset="-15" />
				</anchored>
				<center />
				<static>Tmp</static>
				<tooltip text="Weapon Temp Modifier" />
			</label>
			<label name="modifier_label">
				<anchored to="rightanchor" width="30">
					<top offset="27"/>
					<right anchor="left" relation="relative" offset="-15" />
				</anchored>
				<center />
				<static>Mod</static>
				<tooltip text="weapon Modifier" />
			</label>
			<label name="rating_label">
				<anchored to="rightanchor" width="30">
					<top offset="27"/>
					<right anchor="left" relation="relative" offset="-15" />
				</anchored>
				<center />
				<static>Rtg</static>
				<tooltip text="weapon Rating" />
			</label>			
			<label name="weaponattr_label">
				<anchored to="rightanchor" width="30">
					<top offset="27"/>
					<right anchor="left" relation="relative" offset="-15" />
				</anchored>
				<center />
				<static>Attr</static>
				<tooltip text="Controlling Attribute" />
			</label>
			<label name="weaponname_label">
				<anchored to="rightanchor" width="205">
					<top offset="27"/>
					<right anchor="left" relation="relative" offset="-10" />
				</anchored>
				<center />
				<static>weapon</static>
				<tooltip text="weapon Name" />
			</label>
			<list_charweapon name="weapon">
				<anchored to="weaponframe">
					<left offset="15" />
					<top offset="55" />
					<right offset="-15" />
					<bottom offset="-20" />
				</anchored>
			</list_charweapon>
			<scrollbar_list>
				<anchored to="weapon" />
				<target>weapon</target>
			</scrollbar_list>
			<button_iedit name="weapon_iedit">
				<anchored to="weapon" position="aboveright" offset="5,15" />
				<target>weapon</target>
			</button_iedit>
			<button_iadd name="weapon_iadd">
				<anchored to="weapon_iedit" position="lefthigh" offset="5,10" />
				<target>weapon</target>
			</button_iadd>
		</sheetdata>
	</windowclass>

	<windowclass name="char_weapon">
		<sheetdata>
			<margins control="0,0,0,15" />
			<genericcontrol name="rightanchor">
				<anchored height="0" width="0">
					<top />
					<right />
				</anchored>
			</genericcontrol>
			<button_idelete name="idelete">
				<anchored>
					<top />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-5" />
				</anchored>
			</button_idelete>
			<char_weapontotal name="dice_pool">
				<anchored to="idelete" width="30" height="17">
					<top offset="2"/>
					<right parent="rightanchor" anchor="left" relation="relative" offset="-4" />
				</anchored>
				<tooltip>
					<text>Dice pool</text>
				</tooltip>
				<tabtarget prev="rating" />
					<script>
						function onDragStart(button, x, y, draginfo)
							local nodeWin = window.getDatabaseNode();
							local nDice = nodeWin.getChild("dice_pool").getValue()
							local modDesc, modStack = ModifierStack.getStack(true)
							nDice = nDice + modStack
							local label = nodeWin.getChild("label").getValue()
							local nWoundPen = nodeWin.getParent().getParent().getChild("damage.penalty").getValue();
							wpmsg = ""
							if nWoundPen &lt; 0 then
								wpmsg = " (Wound Penalty: "..nWoundPen..") ";
							end
							nDice = nDice + nWoundPen;
							nDice = math.max(nDice,1);
							tDice = {};
							if nDice > 0 then
								for i = 1, nDice do
									table.insert (tDice, "d6");
								end
								local msg = "[Weapon] ".. label
								if modDesc ~= "" then
									msg = msg .. " (" .. modDesc .. ")"
								end
								msg = msg .. wpmsg;
								local rRoll = { sType = "dicepool", sDesc = msg, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(draginfo, nil, rRoll);
							else
								local rRoll = { sType = "dicepool", sDesc = label, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(draginfo, nil, rRoll);
							end
							return true;						
						end
						
						function onDoubleClick(x, y)
							local nodeWin = window.getDatabaseNode();
							local nDice = nodeWin.getChild("dice_pool").getValue()
							local modDesc, modStack = ModifierStack.getStack(true)
							nDice = nDice + modStack
							local label = nodeWin.getChild("label").getValue()
							local nWoundPen = nodeWin.getParent().getParent().getChild("damage.penalty").getValue();
							wpmsg = ""
							if nWoundPen &lt; 0 then
								wpmsg = " (Wound Penalty: "..nWoundPen..") ";
							end
							nDice = nDice + nWoundPen;
							nDice = math.max(nDice,1);
							
							tDice = {};
							if nDice > 0 then
								for i = 1, nDice do
									table.insert (tDice, "d6");
								end
								local msg = "[Weapon] ".. label
								if modDesc ~= "" then
									msg = msg .. " (" .. modDesc .. ")"
								end
								msg = msg..wpmsg
								local rRoll = { sType = "dicepool", sDesc = msg, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(nil, nil, rRoll);
							else
								local rRoll = { sType = "dicepools", sDesc = label, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(nil, nil, rRoll);
							end
							return true;
						end
					
						function onDrop(x, y, draginfo)
							return windowlist.onDrop(x, y, draginfo);
						end
					</script>
			</char_weapontotal>
			<char_weaponrating name="tempmodifier">
				<anchored to="idelete" width="30" height="17">
					<top offset="2"/>
					<right parent="rightanchor" anchor="left" relation="relative" offset="-17" />
				</anchored>
				<tooltip>
					<text>Temp Modifier</text>
				</tooltip>
				<tabtarget prev="weaponLabel" />
				<script>
					function onGainFocus()
						window.setFrame("rowshade");
					end

					function onLoseFocus()
						window.setFrame(nil);
					end
					
					function onValueChanged()
						local attr_nodename = window.getDatabaseNode().getChild("attribute").getValue()
						local attr_node = window.getDatabaseNode().getParent().getParent()
						local weapon_rating = window.getDatabaseNode().getChild("rating").getValue()
						local weapon_mod = window.getDatabaseNode().getChild("modifier").getValue()
						local weapon_tmod = window.getDatabaseNode().getChild("tempmodifier").getValue()
						if attr_nodename ~= "" and attr_nodename ~= "-" then
							attr_nodename ="attributes."..attr_nodename..".score"
							local a = DB.getValue(attr_node,attr_nodename,0)
							window.getDatabaseNode().getChild("dice_pool").setValue(a+weapon_rating+weapon_mod+weapon_tmod);
						else
							window.getDatabaseNode().getChild("dice_pool").setValue(weapon_rating+weapon_mod+weapon_tmod);
						end
					end					
				</script>
			</char_weaponrating>
			<char_weaponrating name="modifier">
				<anchored to="idelete" width="30" height="17">
					<top offset="2"/>
					<right parent="rightanchor" anchor="left" relation="relative" offset="-17" />
				</anchored>
				<tooltip>
					<text>Modifier</text>
				</tooltip>
				<tabtarget prev="weaponLabel" />
				<script>
					function onGainFocus()
						window.setFrame("rowshade");
					end

					function onLoseFocus()
						window.setFrame(nil);
					end
					
					function onValueChanged()
						local attr_nodename = window.getDatabaseNode().getChild("attribute").getValue()
						local attr_node = window.getDatabaseNode().getParent().getParent()
						local weapon_rating = window.getDatabaseNode().getChild("rating").getValue()
						local weapon_mod = window.getDatabaseNode().getChild("modifier").getValue()
						local weapon_tmod = window.getDatabaseNode().getChild("tempmodifier").getValue()
						if attr_nodename ~= "" and attr_nodename ~= "-" then
							attr_nodename ="attributes."..attr_nodename..".score"
							local a = DB.getValue(attr_node,attr_nodename,0)
							window.getDatabaseNode().getChild("dice_pool").setValue(a+weapon_rating+weapon_mod+weapon_tmod);
						else
							window.getDatabaseNode().getChild("dice_pool").setValue(weapon_rating+weapon_mod+weapon_tmod);
						end
					end					
				</script>
			</char_weaponrating>
			
			<char_weaponrating name="rating">
				<anchored to="idelete" width="30" height="17">
					<top offset="2"/>
					<right parent="rightanchor" anchor="left" relation="relative" offset="-17" />
				</anchored>
				<tooltip>
					<text>Rating</text>
				</tooltip>
				<tabtarget prev="weaponLabel" />
				<script>
					function onGainFocus()
						window.setFrame("rowshade");
					end

					function onLoseFocus()
						window.setFrame(nil);
					end
					
					function onValueChanged()
						local attr_nodename = window.getDatabaseNode().getChild("attribute").getValue()
						local attr_node = window.getDatabaseNode().getParent().getParent()
						local weapon_rating = window.getDatabaseNode().getChild("rating").getValue()
						local weapon_mod = window.getDatabaseNode().getChild("modifier").getValue()
						local weapon_tmod = window.getDatabaseNode().getChild("tempmodifier").getValue()
						
						if attr_nodename ~= "" and attr_nodename ~= "-" then
							attr_nodename ="attributes."..attr_nodename..".score"
							local a = DB.getValue(attr_node,attr_nodename,0)
							window.getDatabaseNode().getChild("dice_pool").setValue(a+weapon_rating+weapon_mod+weapon_tmod);
						else
							window.getDatabaseNode().getChild("dice_pool").setValue(weapon_rating+weapon_mod+weapon_tmod);
						end
					end					
				</script>
			</char_weaponrating>			
			
			<button_stringcycler name="attribute">
				<anchored to="rating" width="30" height="17">
					<top offset="2"/>
					<right parent="rightanchor" anchor="left" relation="relative" offset="-14" />
				</anchored>
			<frame mergerule="replace" name="fielddark" offset="7,5,7,5" />
			<center />
			<font>sheetlabel</font>
			<stateframe mergerule="replace">
				<hover name="fieldfocus" offset="7,5,7,5" />
			</stateframe>
			<parameters>
				<defaultlabel mergerule="replace">base</defaultlabel>
				<labels mergerule="replace">Bod|Agi|Rea|Str|Wil|Log|Int|Cha|MR</labels>
				<values mergerule="replace">body|agility|reaction|strength|willpower|logic|intuition|charisma|magres</values>
			</parameters>
				<script>
					function onInit()
						super.onInit();
						onValueChanged();
					end
					
					function onValueChanged()
						local attr_nodename = window.getDatabaseNode().getChild("attribute").getValue()
						local attr_node = window.getDatabaseNode().getParent().getParent()
						local weapon_rating = window.getDatabaseNode().getChild("rating").getValue()
						local weapon_mod = window.getDatabaseNode().getChild("modifier").getValue()
						local weapon_tmod = window.getDatabaseNode().getChild("tempmodifier").getValue()
						if attr_nodename ~= "" and attr_nodename ~= "-" then
							attr_nodename ="attributes."..attr_nodename..".score"
							local a = DB.getValue(attr_node,attr_nodename,0)
							window.getDatabaseNode().getChild("dice_pool").setValue(a+weapon_rating+weapon_mod+weapon_tmod);
						else
							window.getDatabaseNode().getChild("dice_pool").setValue(weapon_rating+weapon_mod+weapon_tmod);
						end
					end
				</script>			
			</button_stringcycler>
			
			<string_textlistitem name="label">
				<anchored to="attribute" width="205" height="20">
					<top offset="0"/>
					<right parent="rightanchor" anchor="left" relation="relative" offset="-10" />
				</anchored>
				<tabtarget next="bonus" />
			</string_textlistitem>
			
			<!-- remove the skilltype cycler, will not  be used for weapon
			<button_stringcycler name="skilltype">
				<anchored width="75" height="17">
					<top offset="2"/>
					<left offset="5" />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-14" />
				</anchored>
				<font>sheetlabel</font>
				<center />
				<frame name="fielddark" offset="7,5,7,5" />
				<parameters>
					<labels>Act/Cbt|Act/Phy|Social|Magical|Reson|Tech|Vehicle|Know|Lang</labels>
					<values>active_cbt|active_phy|social|magic|resonance|technical|vehicle|knowledge|language</values>
					<defaultlabel>Group</defaultlabel>
					<defaultvalue>-</defaultvalue>
				</parameters>
			</button_stringcycler>-->
			
		</sheetdata>
	</windowclass>
</root>
