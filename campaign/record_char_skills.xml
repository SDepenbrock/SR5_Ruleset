<?xml version="1.0" encoding="iso-8859-1"?>

<!-- Please see the license.html file included with this distribution for 
	attribution and copyright information. -->

<root>
    <windowclass name="charsheet_skills">
		<sheetdata>
			<frame_char name="skillsframe">
				<bounds>15,0,-29,-5</bounds>
			</frame_char>
			<label_frametop>
				<anchored to="skillsframe" />
				<static>Active Skills</static>
			</label_frametop>
			<list_charskill name="skills">
				<anchored to="skillsframe">
					<left offset="15" />
					<top offset="55" />
					<right offset="-15" />
					<bottom offset="-20" />
				</anchored>
			</list_charskill>
			<scrollbar_list>
				<anchored to="skills" />
				<target>skills</target>
			</scrollbar_list>

			<button_iedit name="skills_iedit">
				<anchored to="skills" position="aboveright" offset="5,5" />
				<target>skills</target>
			</button_iedit>
			<button_iadd name="skills_iadd">
				<anchored to="skills_iedit" position="lefthigh" offset="5,0" />
				<target>skills</target>
			</button_iadd>
		</sheetdata>
	</windowclass>

	<windowclass name="char_skill">
		<margins control="0,0,0,2" />

		<sheetdata>
			<genericcontrol name="rightanchor">
				<anchored height="0" width="0">
					<top />
					<right />
				</anchored>
			</genericcontrol>
			<button_idelete name="idelete">
				<anchored>
					<top />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-5" />
				</anchored>
			</button_idelete>
			<char_skilltotal name="dice_pool">
				<anchored to="idelete" width="30" height="20">
					<top offset="2" />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-14" />
				</anchored>
				<tooltip>
					<text>Dice pool</text>
				</tooltip>
				<tabtarget prev="rating" />
					<script>
						function onDragStart(button, x, y, draginfo)
							local nDice = window.getDatabaseNode().getChild("dice_pool").getValue()
							local modDesc, modStack = ModifierStack.getStack(true)
							nDice = nDice + modStack
							local label = window.getDatabaseNode().getChild("label").getValue()
							tDice = {};
							if nDice > 0 then
								for i = 1, nDice do
									table.insert (tDice, "d6");
								end
								local msg = "[Skill] ".. label
								if modDesc ~= "" then
									msg = msg .. " (" .. modDesc .. ")"
								end
								local rRoll = { sType = "dice", sDesc = msg, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(draginfo, nil, rRoll);
							else
								local rRoll = { sType = "dice", sDesc = label, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(draginfo, nil, rRoll);
							end
							return true;						end
						
						function onDoubleClick(x, y)
							local nDice = window.getDatabaseNode().getChild("dice_pool").getValue()
							local modDesc, modStack = ModifierStack.getStack(true)
							nDice = nDice + modStack
							local label = window.getDatabaseNode().getChild("label").getValue()
							tDice = {};
							if nDice > 0 then
								for i = 1, nDice do
									table.insert (tDice, "d6");
								end
								local msg = "[Skill] ".. label
								if modDesc ~= "" then
									msg = msg .. " (" .. modDesc .. ")"
								end
								local rRoll = { sType = "dice", sDesc = msg, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(nil, nil, rRoll);
							else
								local rRoll = { sType = "dice", sDesc = label, aDice = tDice, nMod = 0 };
								ActionsManager.performAction(nil, nil, rRoll);
							end
							return true;
						end
					
						function onDrop(x, y, draginfo)
							return windowlist.onDrop(x, y, draginfo);
						end
					</script>
			</char_skilltotal>
			<char_skillrating name="rating">
				<anchored to="idelete" width="30" height="20">
					<top offset="2" />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-7" />
				</anchored>
				<tooltip>
					<text>Rating</text>
				</tooltip>
				<tabtarget prev="label" />
				<script>
					function onGainFocus()
						window.setFrame("rowshade");
					end

					function onLoseFocus()
						window.setFrame(nil);
					end
					
					function onValueChanged()
						local attr_nodename = window.getDatabaseNode().getChild("attribute").getValue()
						local attr_node = window.getDatabaseNode().getParent().getParent()
						local skill_rating = window.getDatabaseNode().getChild("rating").getValue()
						if attr_nodename ~= "" and attr_nodename ~= "-" then
							attr_nodename ="attributes."..attr_nodename..".score"
							local a = DB.getValue(attr_node,attr_nodename,0)
							window.getDatabaseNode().getChild("dice_pool").setValue(a+skill_rating);
						else
							window.getDatabaseNode().getChild("dice_pool").setValue(skill_rating)
						end
					end					
				</script>
			</char_skillrating>
			<labelcycler name="attribute">
				<anchored to="rating" width="30" height="20">
					<top offset="2" />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-14" />
				</anchored>
				<font>sheetlabel</font>
				<center />
				<frame name="fielddark" offset="7,5,7,5" />
				<parameters>
					<labels>Bod|Agi|Rea|Str|Wil|Log|Int|Cha|Mag|Res</labels>
					<values>body|agility|reaction|strength|willpower|logic|intuition|charisma|magic|resonance</values>
					<defaultlabel>-</defaultlabel>
					<defaultvalue>-</defaultvalue>
				</parameters>
				<script>
					function onInit()
						super.onInit();
						onValueChanged();
					end
					
					function onValueChanged()
						local attr_nodename = window.getDatabaseNode().getChild("attribute").getValue()
						local attr_node = window.getDatabaseNode().getParent().getParent()
						local skill_rating = window.getDatabaseNode().getChild("rating").getValue()
						if attr_nodename ~= "" and attr_nodename ~= "-" then
							attr_nodename ="attributes."..attr_nodename..".score"
							local a = DB.getValue(attr_node,attr_nodename,0)
							window.getDatabaseNode().getChild("dice_pool").setValue(a+skill_rating);
						else
							window.getDatabaseNode().getChild("dice_pool").setValue(skill_ratings)
						end
					end
				</script>
			</labelcycler>
			<string_textlistitem name="label">
				<anchored height="20">
					<top offset="2" />
					<left offset="5" />
					<right parent="rightanchor" anchor="left" relation="relative" offset="-10" />
				</anchored>
				<tabtarget next="bonus" />
			</string_textlistitem>
		</sheetdata>
	</windowclass>
</root>

