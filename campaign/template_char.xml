<?xml version="1.0" encoding="iso-8859-1"?>

<!-- Please see the license.html file included with this distribution for 
	attribution and copyright information. -->

<root>
    <!-- Basic attribute score before modifications -->
    <template name="number_charattribute_base">
		<basicnumber>
			<anchored position="belowleft" 
                offset="0,9" 
                width="24" 
                height="18" />
			<default>1</default>
		</basicnumber>
	</template>
    
    <!-- The grand total: Base class -->
    <template name="number_chartotal">
		<number_modifier>
			<frame name="fieldlight" offset="7,5,7,5" />
			<showemptywidget />
		</number_modifier>
	</template>
    
    <!-- Basic label class for character attributes -->
	<template name="string_charattribute_label">
		<label>
			<anchored position="lefthigh" 
                width="65" 
                height="18" />
			<static />
		</label>
	</template>
    
    <!-- Permanent modifier for attributes, e.g. augmentations -->
    <template name="number_charattribute_permmod">
		<basicnumber>
			<anchored position="right" offset="10,0" width="24" />
			<hideonvalue value="0" />
            <default>0</default>
			<script>
				function onValueChanged()
					local nTarget = DB.getValue(window.getDatabaseNode(), "attributes." .. target[1] .. ".augs", 0);
					if getValue() &gt; nTarget then
						setValue(nTarget);
					end
				end
			</script>
		</basicnumber>
	</template>
    
    <!-- Temporary modifier for attributes, e.g. wounds or similar -->
    <template name="number_charattribute_tempmod">
		<basicnumber>
			<anchored position="right" offset="44,0" width="24" />
			<hideonvalue value="0" />
            <default>0</default>
			<script>
				function onValueChanged()
					local nTarget = DB.getValue(window.getDatabaseNode(), "attributes." .. target[1] .. ".temp", 0);
					if getValue() &gt; nTarget then
						DB.setValue(nTarget);
					end
				end
			</script>
		</basicnumber>
	</template>
    
    <!-- Permanent modifier for initiative scores, e.g. wired reflexes -->
    <template name="number_charinitiative_permmod">
        <basicnumber>
            <anchored position="insidetopleft"
                offset="0,24"
                width="24" />
            <default>0</default>
            <script>
                function onValueChanged()
                    local nTarget = DB.getValue(window.getDatabaseNode(), "initiative." .. target[1] .. ".augs", 0);
                    if getValue() &gt; nTarget then
                        DB.setValue(nTarget);
                    end
                end
            </script>
        </basicnumber>
    </template>
    
    <!-- Temporary modifier for initiative scores, e.g. wounds -->
    <template name="number_charinitiative_tempmod">
        <basicnumber>
            <anchored position="right"
                offset="10,0"
                width="24" />
            <default>0</default>
            <hideonvalue value="0" />
            <script>
                function onValueChanged()
                    local nTarget = DB.getValue(window.getDatabaseNode(), "initiative." .. target[1] .. ".temp", 0);
                    if getValue() &gt; nTarget then
                        DB.setValue(nTarget);
                    end
                end
            </script>
        </basicnumber>
    </template>
    
    <!-- The number of dice for the initiative roll -->
    <template name="number_charinitiative_mult">
        <basicnumber>
            <anchored position="right"
                offset="10,0"
                width="24" />
            <default>1</default>
            <hideonvalue value="1" />
            <script>
                function onValueChanged()
                    local nTarget = DB.getValue(window.getDatabaseNode(), "initiative." .. target[1] .. ".mult", 1);
                    if getValue() &gt; nTarget then
                        DB.setValue(nTarget);
                    end
                end
            </script>
        </basicnumber>
    </template>
    
    <!-- The character's initiative score:
         Components are                     
            - source_one (e.g. reaction)    
            - source_two (e.g. intuition)   
            - perm modifier (e.g. reaction enhancers)   
            - temp modifier (e.g. wounds)   
            - multiplier (e.g. due to wired reflexes)  
    --> 
    <template name="number_charinitiative_score">
        <number_chartotal>
            <anchored position="right"
                offset="12,0"
                width="24" />
            <rollable />
            <script>
            function onSourceUpdate()
                local nodeWin = window.getDatabaseNode();
                local nScoreOne = DB.getValue(nodeWin, "attributes." .. source_one[1] .. ".score",1);
                local nScoreTwo = DB.getValue(nodeWin, "attributes." .. source_two[1] .. ".score",1);
                local nMod = DB.getValue(nodeWin, "initiative." .. target[1] .. ".temp",0);
                local nAugs = DB.getValue(nodeWin, "initiative." .. target[1] .. ".augs",0);
                local nCurrent = math.floor((nScoreOne + nScoreTwo)/2) + nMod + nAugs;
                setValue(nCurrent);
            end
            
            function onInit()
                addSource("attributes." .. source_one[1] .. ".score");
                addSource("attributes." .. source_two[1] .. ".score");
                addSource("initiative." .. target[1] .. ".augs");
                addSource("initiative." .. target[1] .. ".temp");
                
                super.onInit();
            end
            
            function action(draginfo)
                local nodeWin = window.getDatabaseNode();
                if nodeWin then
                    local nTotal = DB.getValue(nodeWin,
                            "initiative." .. target[1] .. ".score");
                    local nMult = DB.getValue(nodeWin, "initiative." .. target[1] .. ".mult");
                    local iLabel = self.alabel[1];
                    
                    local rActor = ActorManager.getActor("pc", nodeWin.getChild("..."));
                    local sDesc = "[Initiative] " .. iLabel;
                    local rRoll = {sType = "dice", sDesc = sDesc, aDice = {"d6"}, nDice=nMult, nMod = nTotal};
                    ActionsManager.performAction(draginfo, rActor, rRoll, 0);
                end
            end
            
            function onDragStart(button, x, y,  draginfo)
                return action(draginfo);
            end
            
            function onDoubleClick(x,y)
                return action();
            end
            </script>
        </number_chartotal>
    </template>
    
    <!-- Base class for final tally of attribute.           
         Components are:                                    
            - base score                                    
            - augmentation modifier                         
            - temporary modifier (e.g. wounds or toxins)    
    -->
    <template name="number_charattribute_score">
		<number_chartotal>
			<anchored position="right" 
                offset="78" 
                width="24" />
            <rollable />
            <script>
            function onSourceUpdate()
                local nodeWin = window.getDatabaseNode();
                local nBase = DB.getValue(nodeWin, "attributes." .. target[1] .. ".base", 1);
                local nAugs = DB.getValue(nodeWin, "attributes." .. target[1] .. ".augs", 0);
                local nTemp = DB.getValue(nodeWin, "attributes." .. target[1] .. ".temp", 0);
                local nCurrent = nBase + nAugs + nTemp;
                setValue(nCurrent);
            end
            
            function onInit()
                addSource("attributes." .. target[1] .. ".base");
                addSource("attributes." .. target[1] .. ".augs");
                addSource("attributes." .. target[1] .. ".temp");
                
                super.onInit();
            end
            
            function action(draginfo)
                local nodeWin = window.getDatabaseNode();
                if nodeWin then
                    local nTotal = DB.getValue(nodeWin, 
                            "attributes." .. target[1] .. ".score");
                    local aLabel = self.alabel[1];

                    local rActor = ActorManager.getActor("pc", nodeWin.getChild("..."));
                    local sDesc = "[ATTRIBUTE] " .. aLabel;
                    local rRoll = { sType = "dice", sDesc = sDesc, aDice = {"d6"}, nDice=nTotal, nMod = 0 };
                    ActionsManager.performAction(draginfo, rActor, rRoll, 0);
                end
            end
            
            function onDragStart(button, x, y, draginfo)
                return action(draginfo);
            end
            
            function onDoubleClick(x,y)
                return action();
            end
            </script>
		</number_chartotal>
	</template>
    
    <!-- label for our attributes -->
	<template name="string_labeled">
		<stringfield>
			<font>sheettext</font>
			<lineoffset default="on">1</lineoffset>
			<script>
				labelwidget = nil;

				function onInit()
				labelwidget = addTextWidget("sheetlabelinline", string.upper(label[1]));
				if labelwidget then
				local w,h = labelwidget.getSize();
				labelwidget.setPosition("bottomleft", w/2, h/2-4);
				end
				end
			</script>
		</stringfield>
	</template>

	<template name="list_charskill">
		<list_text>
			<datasource>.skilllist</datasource>
			<class>char_skill</class>
			<columns width="225" filldown="true" />
			<sortby>
				<control>label</control>
			</sortby>
			<newfocus>label</newfocus>
			<script>
				function onDrop(x, y, draginfo)
				local sDragType = draginfo.getType();
				if sDragType == "number" then
				local w = addEntry(true);
				if w then
				w.label.setValue(draginfo.getDescription());
				w.bonus.setValue(draginfo.getNumberData());
				end
				return true;
				elseif sDragType == "dice" then
				local aDropDice = draginfo.getDieList();
				local w = getWindowAt(x,y);
				if w then
				for _,vDie in ipairs(aDropDice) do
				w.dice.addDie(vDie.type);
				end
				else
				w = addEntry(true);
				if w then
				w.label.setValue(draginfo.getDescription());
				w.bonus.setValue(draginfo.getNumberData());
				for _,vDie in ipairs(aDropDice) do
				w.dice.addDie(vDie.type);
				end
				end
				end
				return true;
				end
				end
			</script>
		</list_text>
	</template>


	<template name="number_charinv">
		<basicnumber>
			<nodrag />
			<hideonvalue>0</hideonvalue>
			<min>0</min>
		</basicnumber>
	</template>
	<template name="string_charinvname">
		<string_textlistitem>
			<script file="campaign/scripts/char_invname.lua" />
		</string_textlistitem>
	</template>
	<template name="string_charinvloc">
		<string_textlistitem>
			<nodelete />
			<script file="campaign/scripts/char_invloc.lua" />
		</string_textlistitem>
	</template>
	<template name="list_charinv">
		<windowlist>
			<datasource>.inventorylist</datasource>
			<class>char_invitem</class>
			<allowcreate />
			<allowdelete />
			<script file="campaign/scripts/char_invlist.lua" />
		</windowlist>
	</template>

	<template name="list_language">
		<list_text>
			<datasource>.languagelist</datasource>
			<class>char_language</class>
			<sortby>
				<control>name</control>
			</sortby>
			<newfocus>name</newfocus>
			<allowcreate />
			<allowdelete />
			<script>
				function onDrop(x, y, draginfo)
				if draginfo.getType() == "string" then
				local w = addEntry(true);
				w.name.setValue(draginfo.getStringData());
				return true;
				end
				end
			</script>
		</list_text>
	</template>
</root>
